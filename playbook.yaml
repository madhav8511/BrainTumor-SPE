- name: Update and restart Kubernetes deployment
  hosts: local
  connection: local

  vars:
    kubeconfig_src: kubeconfig-jenkins.yaml
    kubeconfig_dest: /tmp/kubeconfig-jenkins

  tasks:

    - name: Copy kubeconfig (decrypted) for kubectl
      copy:
        src: "{{ kubeconfig_src }}"
        dest: "{{ kubeconfig_dest }}"
        mode: '0600'
      
    - name: Apply backend manifest (creates deployment/service if missing)
      environment:
        KUBECONFIG: "{{ kubeconfig_dest }}"
      command: >
        kubectl apply -f backend/backend-deploy.yaml

    - name: Update image
      environment:
        KUBECONFIG: "{{ kubeconfig_dest }}"
      command: >
        kubectl set image deployment/brain-api brain-api=madhavgirdhar/braintumor:{{ build_number }}

    - name: Restart deployment
      environment:
        KUBECONFIG: "{{ kubeconfig_dest }}"
      command: >
       kubectl rollout restart deployment/brain-api